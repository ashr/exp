package main

import (
	"fmt"
	"log"
)

// fixDupFiles fixes duplicates source files by adding numeric suffixes.
func fixDupFiles(sectName string, files []*SourceFile) {
	// Record the number of occurances of each source file.
	count := make(map[string]int)
	for _, file := range files {
		count[file.Name]++
	}

	// Add counter for duplicate files, starting at 1. The counter represents the
	// suffix and is incremented with each occurance of a given file name.
	m := make(map[string]int)
	for _, file := range files {
		if count[file.Name] > 1 {
			m[file.Name] = 1
		}
	}
	for _, file := range files {
		if n := m[file.Name]; n != 0 {
			m[file.Name]++
			if verbose {
				log.Printf(`Duplicate %q source file in section %q; adding "_%d" suffix.`, file.Name, sectName, n)
			}
			file.Name = fmt.Sprintf("%s_%d", file.Name, n)
		}
	}
}

// SourceFile maps between address ranges and source code file names.
type SourceFile struct {
	// File name without extension.
	Name string
	// Start address.
	Start uint64
	// End address.
	End uint64
}

// ref: https://github.com/sanctuary/notes/blob/master/functions/README.md
var textFiles = []*SourceFile{
	{"_crt", 0x401000, 0x401029},
	{"appfat", 0x40102A, 0x401DA3},
	{"automap", 0x401DA4, 0x40311A},
	{"capture", 0x40311B, 0x4034D8},
	{"codec", 0x4034D9, 0x4037D3},
	{"control", 0x4037D4, 0x407409},
	{"cursor", 0x40740A, 0x4084A5},
	{"dead", 0x4084A6, 0x4086F3},
	{"debug", 0x4086F4, 0x4087B0},
	{"diablo", 0x4087B1, 0x40ACAC},
	{"doom", 0x40ACAD, 0x40ADD5},
	{"drlg_l1", 0x40ADD6, 0x40D356},
	{"drlg_l2", 0x40D357, 0x40FF80},
	{"drlg_l3", 0x40FF81, 0x412654},
	{"drlg_l4", 0x412655, 0x415097},
	{"dthread", 0x415098, 0x415361},
	{"dx", 0x415362, 0x4158A8},
	{"effects", 0x4158A9, 0x415F42},
	{"encrypt", 0x415F43, 0x4161FB},
	{"engine", 0x4161FC, 0x41804D},
	{"error", 0x41804E, 0x4182AC},
	{"exception", 0x4182AD, 0x418865},
	{"gamemenu", 0x418866, 0x418C8A},
	{"gendung", 0x418C8B, 0x419E8A},
	{"gmenu", 0x419E8B, 0x41A552},
	{"help", 0x41A553, 0x41A7B2},
	{"init", 0x41A7B3, 0x41B18F},
	{"interfac", 0x41B190, 0x41B813},
	{"inv", 0x41B814, 0x41F095},
	{"items", 0x41F096, 0x425442},
	{"lighting", 0x425443, 0x426563},
	{"loadsave", 0x426564, 0x4279F1},
	{"log", 0x4279F2, 0x427E0D},
	{"mainmenu", 0x427E0E, 0x428055},
	{"minitext", 0x428056, 0x4283BF},
	{"missiles", 0x4283C0, 0x430FDE},
	{"monster", 0x430FDF, 0x43AD32},
	{"movie", 0x43AD33, 0x43AE8F},
	{"mpqapi", 0x43AE90, 0x43BBA3},
	{"msg", 0x43BBA4, 0x43F848},
	{"msgcmd", 0x43F849, 0x43FAC3},
	{"multi", 0x43FAC4, 0x440DAD},
	{"nthread", 0x440DAE, 0x44121C},
	{"objects", 0x44121D, 0x448754},
	{"hero", 0x448755, 0x448DF4},
	{"palette", 0x448DF5, 0x4493D3},
	{"path", 0x4493D4, 0x4498EB},
	{"pfile", 0x4498EC, 0x44A8E5},
	{"player", 0x44A8E6, 0x450D32},
	{"plrmsg", 0x450D33, 0x450FFD},
	{"portal", 0x450FFE, 0x45138D},
	{"quests", 0x45138E, 0x452830},
	{"restricted", 0x452831, 0x452974},
	{"scrollrt", 0x452975, 0x456624},
	{"setmaps", 0x456625, 0x456A15},
	{"sha1", 0x456A16, 0x456CBA},
	{"sound", 0x456CBB, 0x45744D},
	{"spell", 0x45744E, 0x457A00},
	{"stores", 0x457A01, 0x45C198},
	{"sync", 0x45C199, 0x45C86F},
	{"themes", 0x45C870, 0x45E08B},
	{"tmsg", 0x45E08C, 0x45E150},
	{"town", 0x45E151, 0x46019A},
	{"towners", 0x46019B, 0x4618A4},
	{"track", 0x4618A5, 0x4619A6},
	{"trigs", 0x4619A7, 0x462C6C},
	{"wave", 0x462C6D, 0x46305F},
	{"world", 0x463060, 0x469719},
	{"_crt", 0x46971A, 0x47746F},
	{"pkware", 0x477470, 0x478FFF},
}

// ref: https://github.com/sanctuary/notes/blob/master/rdata/README.md
var rdataFiles = []*SourceFile{
	{"_idata", 0x479000, 0x4793FF},
	{"_crt", 0x479400, 0x479403},
	{"capture", 0x479404, 0x479423},
	{"control", 0x479424, 0x479657},
	{"cursor", 0x479658, 0x479BF7},
	{"diablo", 0x479BF8, 0x479C23},
	{"drlg_l1", 0x479C24, 0x479F83},
	{"drlg_l3", 0x479F84, 0x47A2CF},
	{"drlg_l4", 0x47A2D0, 0x47A45F},
	{"dthread", 0x47A460, 0x47A463},
	{"dx", 0x47A464, 0x47A467},
	{"effects", 0x47A468, 0x47A473},
	{"engine", 0x47A474, 0x47A47F},
	{"exception", 0x47A480, 0x47A48B},
	{"gmenu", 0x47A48C, 0x47A543},
	{"help", 0x47A544, 0x47AE1F},
	{"init", 0x47AE20, 0x47AE3F},
	{"interfac", 0x47AE40, 0x47AE5F},
	{"inv", 0x47AE60, 0x47B0A7},
	{"items", 0x47B0A8, 0x47F047},
	{"lighting", 0x47F048, 0x47F06F},
	{"log", 0x47F070, 0x47F073},
	{"mainmenu", 0x47F074, 0x47F077},
	{"minitext", 0x47F078, 0x47F12F},
	{"monster", 0x47F130, 0x47F143},
	{"movie", 0x47F144, 0x47F147},
	{"mpqapi", 0x47F148, 0x47F14B},
	{"msg", 0x47F14C, 0x47F14F},
	{"msgcmd", 0x47F150, 0x47F153},
	{"multi", 0x47F154, 0x47F163},
	{"nthread", 0x47F164, 0x47F167},
	{"hero", 0x47F168, 0x47F16B},
	{"palette", 0x47F16C, 0x47F1AF},
	{"path", 0x47F1B0, 0x47F1BF},
	{"pfile", 0x47F1C0, 0x47F203},
	{"player", 0x47F204, 0x47F22F},
	{"plrmsg", 0x47F230, 0x47F237},
	{"scrollrt", 0x47F238, 0x47F24B},
	{"sound", 0x47F24C, 0x4802AB},
	{"towners", 0x4802AC, 0x4802CF},
	{"track", 0x4802D0, 0x4802D3},
	{"wave", 0x4802D4, 0x4802D7},
	{"_crt", 0x4802D8, 0x482FFF},
}

// ref: https://github.com/sanctuary/notes/blob/master/data/README.md
var dataFiles = []*SourceFile{
	{"_crt", 0x483000, 0x4830B7},
	{"appfat", 0x4830B8, 0x483B0F},
	{"automap", 0x483B10, 0x483B8F},
	{"codec", 0x483B90, 0x483BAB},
	{"pkware", 0x483BAC, 0x483C2B},
	{"control", 0x483C2C, 0x48424F},
	{"cursor", 0x484250, 0x4842A7},
	{"debug", 0x4842A8, 0x4842E3},
	{"pkware", 0x4842E4, 0x484363},
	{"diablo", 0x484364, 0x4846AF},
	{"doom", 0x4846B0, 0x4846F7},
	{"pkware", 0x4846F8, 0x484777},
	{"drlg_l1", 0x484778, 0x4847D7},
	{"pkware", 0x4847D8, 0x484857},
	{"drlg_l2", 0x484858, 0x48613B},
	{"pkware", 0x48613C, 0x4861BB},
	{"drlg_l4", 0x4861BC, 0x4862AF},
	{"dthread", 0x4862B0, 0x4862F3},
	{"dx", 0x4862F4, 0x48636F},
	{"effects", 0x486370, 0x48D6EF},
	{"pkware", 0x48D6F0, 0x48D76F},
	{"engine", 0x48D770, 0x48D7C3},
	{"error", 0x48D7C4, 0x48DE7F},
	{"exception", 0x48DE80, 0x48E1B7},
	{"gamemenu", 0x48E1B8, 0x48E357},
	{"gendung", 0x48E358, 0x48E3E7},
	{"gmenu", 0x48E3E8, 0x48E44B},
	{"help", 0x48E44C, 0x48E487},
	{"init", 0x48E488, 0x48E80F},
	{"interfac", 0x48E810, 0x48E9A7},
	{"inv", 0x48E9A8, 0x48EA8B},
	{"items", 0x48EA8C, 0x49387B},
	{"lighting", 0x49387C, 0x4947BF},
	{"loadsave", 0x4947C0, 0x4947D3},
	{"log", 0x4947D4, 0x494897},
	{"mainmenu", 0x494898, 0x4948F7},
	{"minitext", 0x4948F8, 0x494947},
	{"missiles", 0x494948, 0x497E07},
	{"monster", 0x497E08, 0x49EEF7},
	{"mpqapi", 0x49EEF8, 0x49EFA7},
	{"msg", 0x49EFA8, 0x49F06F},
	{"_crt", 0x49F070, 0x49F08B},
	{"multi", 0x49F08C, 0x49F203},
	{"nthread", 0x49F204, 0x49F287},
	{"objects", 0x49F288, 0x4A0D07},
	{"palette", 0x4A0D08, 0x4A0D6F},
	{"path", 0x4A0D70, 0x4A0D7B},
	{"pfile", 0x4A0D7C, 0x4A0EF7},
	{"player", 0x4A0EF8, 0x4A1AAB},
	{"plrmsg", 0x4A1AAC, 0x4A1ABB},
	{"portal", 0x4A1ABC, 0x4A1ADF},
	{"quests", 0x4A1AE0, 0x4A1E07},
	{"restricted", 0x4A1E08, 0x4A1E3F},
	{"pkware", 0x4A1E40, 0x4A1EBF},
	{"scrollrt", 0x4A1EC0, 0x4A208B},
	{"setmaps", 0x4A208C, 0x4A22D3},
	{"sound", 0x4A22D4, 0x4A23C7},
	{"spell", 0x4A23C8, 0x4A2D5B},
	{"stores", 0x4A2D5C, 0x4B2583},
	{"themes", 0x4B2584, 0x4B26A3},
	{"town", 0x4B26A4, 0x4B2723},
	{"towners", 0x4B2724, 0x4B2F77},
	{"trigs", 0x4B2F78, 0x4B325B},
	{"world", 0x4B325C, 0x4B354F},
	{"_crt", 0x4B3550, 0x4B701F},
	{"pkware", 0x4B7020, 0x4B792F},
}

// ref: https://github.com/sanctuary/notes/blob/master/bss/README.md
var bssFiles = []*SourceFile{
	{"_crt", 0x4B7930, 0x4B7933},
	{"appfat", 0x4B7934, 0x4B7A3F},
	{"automap", 0x4B7A40, 0x4B84CB},
	{"control", 0x4B84CC, 0x4B8C9B},
	{"cursor", 0x4B8C9C, 0x4B8CD7},
	{"dead", 0x4B8CD8, 0x4BD2FB},
	{"debug", 0x4BD2FC, 0x525513},
	{"diablo", 0x525514, 0x52574F},
	{"doom", 0x525750, 0x525763},
	{"drlg_l1", 0x525764, 0x5276C7},
	{"drlg_l2", 0x5276C8, 0x528377},
	{"drlg_l3", 0x528378, 0x5289C3},
	{"drlg_l4", 0x5289C4, 0x52A4DF},
	{"dthread", 0x52A4E0, 0x52A50F},
	{"dx", 0x52A510, 0x52A54F},
	{"effects", 0x52A550, 0x52A563},
	{"encrypt", 0x52A564, 0x52B967},
	{"engine", 0x52B968, 0x52B99F},
	{"error", 0x52B9A0, 0x52B9F3},
	{"exception", 0x52B9F4, 0x52B9FF},
	{"gendung", 0x52BA00, 0x63445F},
	{"gmenu", 0x634460, 0x63448F},
	{"help", 0x634490, 0x634967},
	{"init", 0x634968, 0x634CA7},
	{"interfac", 0x634CA8, 0x634CB7},
	{"inv", 0x634CB8, 0x634CC3},
	{"items", 0x634CC4, 0x6414E7},
	{"lighting", 0x6414E8, 0x646A2B},
	{"loadsave", 0x646A2C, 0x646A2F},
	{"log", 0x646A30, 0x646CDF},
	{"mainmenu", 0x646CE0, 0x646CF3},
	{"minitext", 0x646CF4, 0x646D17},
	{"missiles", 0x646D18, 0x64CCDF},
	{"monster", 0x64CCE0, 0x659AF3},
	{"movie", 0x659AF4, 0x659AFF},
	{"mpqapi", 0x659B00, 0x65AB17},
	{"msg", 0x65AB18, 0x67619F},
	{"msgcmd", 0x6761A0, 0x6761B7},
	{"multi", 0x6761B8, 0x6796FF},
	{"nthread", 0x679700, 0x679767},
	{"objects", 0x679768, 0x67D7C7},
	{"hero", 0x67D7C8, 0x67D7CB},
	{"palette", 0x67D7CC, 0x67E3D7},
	{"path", 0x67E3D8, 0x6862DF},
	{"pfile", 0x6862E0, 0x68642F},
	{"player", 0x686430, 0x69B7CF},
	{"plrmsg", 0x69B7D0, 0x69BC97},
	{"portal", 0x69BC98, 0x69BCFF},
	{"quests", 0x69BD00, 0x69BEF7},
	{"scrollrt", 0x69BEF8, 0x69EFAF},
	{"sha1", 0x69EFB0, 0x69F0C3},
	{"sound", 0x69F0C4, 0x69F107},
	{"stores", 0x69F108, 0x6AA707},
	{"sync", 0x6AA708, 0x6AAA37},
	{"themes", 0x6AAA38, 0x6AAC13},
	{"tmsg", 0x6AAC14, 0x6AAC17},
	{"towners", 0x6AAC18, 0x6ABAB7},
	{"track", 0x6ABAB8, 0x6ABAC7},
	{"trigs", 0x6ABAC8, 0x6ABB33},
	{"wave", 0x6ABB34, 0x6ABB37},
	{"_crt", 0x6ABB38, 0x6ADFFF},
}
